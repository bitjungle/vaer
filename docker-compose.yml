services:
  # ============================================================================
  # metno-proxy: Nginx reverse proxy for api.met.no
  # ============================================================================
  metno-proxy:
    container_name: metno-proxy
    build:
      context: ./nginx
      dockerfile: Dockerfile
      args:
        # Override this with your own User-Agent
        METNO_USER_AGENT: "vaer/0.1.0 developer@example.com"
    ports:
      - "8080:80"
    environment:
      - TZ=Europe/Oslo
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthz"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - vaer-network

  # ============================================================================
  # vaer: MCP server providing weather tools
  # ============================================================================
  vaer:
    container_name: vaer
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    depends_on:
      metno-proxy:
        condition: service_healthy
    environment:
      # Required: URL to metno-proxy
      - METNO_PROXY_BASE_URL=http://metno-proxy:80

      # Optional: HTTP timeout to proxy
      - METNO_TIMEOUT_MS=5000

      # Optional: Frost API credentials for observations
      # Get from: https://frost.met.no/auth/requestCredentials.html
      # - FROST_CLIENT_ID=your-client-id-here

      # Optional: Logging level
      - VAER_LOG_LEVEL=info

      # HTTP transport enabled by default for Docker deployment
      # For stdio transport, use: docker compose run --rm vaer
      - VAER_PORT=3000

      # Optional: Authentication for HTTP transport (Phase 9)
      # - VAER_AUTH_MODE=none
      # - VAER_API_KEY=your-api-key-here

      - NODE_ENV=production

    # HTTP transport port
    ports:
      - "3000:3000"

    # Note: places.db is baked into the Docker image during build.
    # Do NOT mount ./data as a volume - it overrides the image's data
    # and causes permission issues (host UID vs container UID 1001).
    # For development, create docker-compose.override.yml (gitignored).

    # Health check for HTTP transport
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

    restart: unless-stopped
    networks:
      - vaer-network

    # For stdio transport, you would typically run this interactively:
    # docker compose run --rm vaer
    #
    # Or connect from an MCP client using:
    # docker compose exec vaer node dist/index.js

networks:
  vaer-network:
    driver: bridge

# ============================================================================
# Usage Examples
# ============================================================================
#
# Start all services:
#   docker compose up -d
#
# View logs:
#   docker compose logs -f
#   docker compose logs -f vaer
#   docker compose logs -f metno-proxy
#
# Test metno-proxy health:
#   curl http://localhost:8080/healthz
#
# Test metno-proxy forecast:
#   curl "http://localhost:8080/weatherapi/locationforecast/2.0/compact?lat=59.91&lon=10.75"
#
# Run MCP server interactively (stdio transport):
#   docker compose run --rm vaer
#
# Test with MCP Inspector (if HTTP transport enabled):
#   npx @modelcontextprotocol/inspector http://localhost:3000/mcp
#
# Stop all services:
#   docker compose down
#
# Rebuild and restart:
#   docker compose up -d --build
#
# View running containers:
#   docker compose ps
